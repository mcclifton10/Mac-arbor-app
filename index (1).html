<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAC-ARBOR Field Technician</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #666;
            font-size: 13px;
        }
        
        .hidden {
            display: none;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-navigate {
            background: #2196F3;
            color: white;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-arrival {
            background: #4caf50;
            color: white;
            font-size: 18px;
            padding: 18px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-box {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 26px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        .customer-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .customer-card.completed {
            background: #f0f0f0;
            border-left-color: #9e9e9e;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        .customer-card.completed .btn {
            opacity: 0.6;
        }
        
        .customer-card.active {
            background: #fff3e0;
            border-left-color: #ff9800;
            border-left-width: 6px;
        }
        
        .customer-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .customer-name {
            font-size: 17px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }
        
        .customer-address {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }
        
        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }
        
        .paste-area {
            width: 100%;
            min-height: 180px;
            padding: 12px;
            border: 3px dashed #667eea;
            border-radius: 10px;
            font-size: 13px;
            font-family: monospace;
            resize: vertical;
            background: #f8f9ff;
        }
        
        .instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .photo-section {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border: 2px dashed #667eea;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .photo-preview img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .completed-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .active-badge {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .arrival-banner {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .timer-display {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .timer-number {
            font-size: 32px;
            font-weight: 700;
            color: #ff9800;
            font-family: 'Courier New', monospace;
        }
        
        .timer-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card header">
            <h1>üöõ MAC-ARBOR Field Tech</h1>
            <p>Route Optimization & Service Tracking</p>
        </div>
        
        <!-- Load Route Screen -->
        <div id="loadScreen" class="card">
            <div id="savedRouteNotice" class="hidden" style="background: #e3f2fd; border: 2px solid #2196F3; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
                <strong>üíæ Saved Route Detected</strong><br>
                <span style="font-size: 13px;" id="savedRouteInfo"></span><br>
                <button class="btn btn-success" onclick="resumeSavedRoute()" style="margin-top: 10px;">
                    ‚ñ∂Ô∏è Resume Saved Route
                </button>
            </div>
            
            <div class="instructions">
                <strong>üìã Paste CSV Route Data:</strong><br>
                1. Open CSV from email<br>
                2. Copy ALL text (Ctrl+A, Ctrl+C)<br>
                3. Paste below<br>
                4. Tap "Load Route"
            </div>
            
            <textarea id="csvInput" class="paste-area" placeholder="Paste your route CSV here..."></textarea>
            
            <button class="btn btn-primary" onclick="loadRoute()">üöÄ Load Route</button>
            <button class="btn btn-secondary" onclick="loadDemo()">üì± Load Demo Route</button>
        </div>
        
        <!-- Route List Screen -->
        <div id="routeScreen" class="card hidden">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="totalStops">0</div>
                    <div class="stat-label">TOTAL</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="completedStops">0</div>
                    <div class="stat-label">DONE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="remainingStops">0</div>
                    <div class="stat-label">LEFT</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="optimizeRoute()">
                üéØ Optimize Route from My Location
            </button>
            
            <div id="customerList" style="margin-top: 15px;"></div>
            
            <button class="btn btn-warning" onclick="exportTickets()">
                üì§ Export Completed Tickets
            </button>
            
            <button class="btn btn-secondary" onclick="newRoute()">
                üìù Load New Route
            </button>
        </div>
        
        <!-- Service Ticket Screen -->
        <div id="ticketScreen" class="card hidden">
            <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;" id="ticketHeader"></div>
            
            <div class="timer-display" id="timerDisplay">
                <div class="timer-number" id="timerNumber">00:00:00</div>
                <div class="timer-label">‚è±Ô∏è TIME ON SITE</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Service Date:</label>
                <input type="text" class="form-input" id="serviceDate" readonly style="background: #f0f0f0;">
            </div>
            
            <div class="form-group">
                <label class="form-label">Problem Treated:</label>
                <input type="text" class="form-input" id="problemTreated" placeholder="ANTS, ROACHES, TERMITES, etc.">
            </div>
            
            <div class="form-group">
                <label class="form-label">Type of Treatment:</label>
                <input type="text" class="form-input" id="treatmentType" placeholder="CRACK AND CREVICE, PERIMETER, etc.">
            </div>
            
            <div class="form-group">
                <label class="form-label">Area or Plants Treated:</label>
                <input type="text" class="form-input" id="areaTreated" placeholder="KITCHEN, YARD, etc.">
            </div>
            
            <div class="form-group">
                <label class="form-label">Chemical Used:</label>
                <input type="text" class="form-input" id="chemicalUsed" placeholder="TALSTAR, TERMIDOR, etc.">
            </div>
            
            <div class="form-group">
                <label class="form-label">Rate Used:</label>
                <input type="text" class="form-input" id="rateUsed" placeholder=".5 OZ/GALLON">
            </div>
            
            <div class="form-group">
                <label class="form-label">Gallons Used:</label>
                <input type="text" class="form-input" id="gallonsUsed" placeholder="1">
            </div>
            
            <div class="form-group">
                <label class="form-label">Equipment Used:</label>
                <input type="text" class="form-input" id="equipmentUsed" placeholder="1 B&G">
            </div>
            
            <div class="form-group">
                <label class="form-label">Service Notes:</label>
                <textarea class="form-input" id="serviceNotes" placeholder="Describe service performed..."></textarea>
            </div>
            
            <div class="photo-section">
                <strong>üì∏ Add Photo</strong><br>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePhoto(event)">
                <button class="btn btn-primary" onclick="openCamera()" style="margin-top:10px;">
                    üì∑ Take Photo
                </button>
                <div class="photo-preview hidden" id="photoPreview">
                    <img id="photoImage" src="">
                    <button class="btn btn-warning" onclick="removePhoto()" style="margin-top:10px;width:auto;padding:10px 20px;">
                        üóëÔ∏è Remove Photo
                    </button>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="saveTicket()">
                ‚úÖ Save & Mark Complete
            </button>
            
            <button class="btn btn-secondary" onclick="backToRoute()">
                ‚Üê Back to Route
            </button>
        </div>
        
        <!-- Arrival Banner (shows when navigating) -->
        <div id="arrivalBanner" class="card hidden">
            <div class="arrival-banner">
                üß≠ Navigating to Customer...
            </div>
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                <strong>üí° Google Maps is opening</strong><br>
                <span style="font-size: 13px;">When you arrive, come back here and tap the button below!</span>
            </div>
            
            <div id="arrivalCustomerInfo" style="margin-bottom: 15px;"></div>
            
            <button class="btn btn-arrival" onclick="arrivedAtCustomer()">
                ‚úÖ I'M HERE - Start Service
            </button>
            
            <button class="btn btn-secondary" onclick="backToRoute()">
                ‚Üê Back to Route List
            </button>
        </div>
    </div>

    <script>
        let customers = [];
        let completedTickets = [];
        let currentCustomerIndex = -1;
        let currentPhoto = null;
        let navigatingToIndex = -1;
        let arrivalTime = null;
        let timerInterval = null;
        let userLat = null;
        let userLng = null;
        let locationWatchId = null;
        
        // Load saved data on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            startLocationTracking();
        });
        
        function startLocationTracking() {
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(
                    position => {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        checkProximityToCustomer();
                    },
                    error => console.log('Location tracking error:', error),
                    { enableHighAccuracy: true, maximumAge: 10000 }
                );
            }
        }
        
        function checkProximityToCustomer() {
            if (navigatingToIndex !== -1 && !arrivalTime && userLat && userLng) {
                const customer = customers[navigatingToIndex];
                const dist = distance(userLat, userLng, customer.lat, customer.lng) * 1000; // Convert to meters
                
                // Within 100 yards (91.44 meters) - start timer automatically
                if (dist <= 100) {
                    startArrivalTimer();
                }
            }
        }
        
        function startArrivalTimer() {
            if (!arrivalTime) {
                arrivalTime = new Date();
                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            }
        }
        
        function stopArrivalTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateTimer() {
            if (!arrivalTime) return;
            
            const now = new Date();
            const elapsed = Math.floor((now - arrivalTime) / 1000); // seconds
            
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const timerEl = document.getElementById('timerNumber');
            if (timerEl) {
                timerEl.textContent = timeStr;
            }
        }
        
        function getElapsedTime() {
            if (!arrivalTime) return '0:00';
            
            const now = new Date();
            const elapsed = Math.floor((now - arrivalTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }
        
        function saveData() {
            try {
                localStorage.setItem('macarbor_customers', JSON.stringify(customers));
                // Don't save tickets with photos - they're too big for localStorage
                const ticketsWithoutPhotos = completedTickets.map(t => ({
                    ...t,
                    photo: null // Remove photo data
                }));
                localStorage.setItem('macarbor_tickets', JSON.stringify(ticketsWithoutPhotos));
                localStorage.setItem('macarbor_lastSaved', new Date().toISOString());
            } catch (e) {
                console.error('Could not save data:', e);
                // If still fails, just save customers without tickets
                try {
                    localStorage.setItem('macarbor_customers', JSON.stringify(customers));
                    localStorage.setItem('macarbor_lastSaved', new Date().toISOString());
                } catch (e2) {
                    console.error('Could not save even without photos:', e2);
                }
            }
        }
        
        function loadSavedData() {
            try {
                const savedCustomers = localStorage.getItem('macarbor_customers');
                const savedTickets = localStorage.getItem('macarbor_tickets');
                const lastSaved = localStorage.getItem('macarbor_lastSaved');
                
                if (savedCustomers) {
                    const parsedCustomers = JSON.parse(savedCustomers);
                    if (parsedCustomers.length > 0) {
                        // Show saved route notice on load screen
                        const completed = parsedCustomers.filter(c => c.completed).length;
                        const total = parsedCustomers.length;
                        const remaining = total - completed;
                        
                        document.getElementById('savedRouteNotice').classList.remove('hidden');
                        document.getElementById('savedRouteInfo').innerHTML = 
                            `${total} stops (${completed} done, ${remaining} remaining)<br>` +
                            `Last saved: ${lastSaved ? new Date(lastSaved).toLocaleString() : 'Unknown'}`;
                    }
                }
                
                if (savedTickets) {
                    completedTickets = JSON.parse(savedTickets);
                }
            } catch (e) {
                console.error('Could not load saved data:', e);
            }
        }
        
        function resumeSavedRoute() {
            try {
                const savedCustomers = localStorage.getItem('macarbor_customers');
                const savedTickets = localStorage.getItem('macarbor_tickets');
                
                if (savedCustomers) {
                    customers = JSON.parse(savedCustomers);
                    if (savedTickets) {
                        completedTickets = JSON.parse(savedTickets);
                    }
                    showRouteScreen();
                    updateStats();
                    displayCustomers();
                }
            } catch (e) {
                alert('Error loading saved route: ' + e.message);
            }
        }
        
        function clearSavedData() {
            if (confirm('Clear all saved route data? This cannot be undone.')) {
                localStorage.removeItem('macarbor_customers');
                localStorage.removeItem('macarbor_tickets');
                localStorage.removeItem('macarbor_lastSaved');
                customers = [];
                completedTickets = [];
                navigatingToIndex = -1;
                document.getElementById('csvInput').value = '';
                document.getElementById('loadScreen').classList.remove('hidden');
                document.getElementById('routeScreen').classList.add('hidden');
                document.getElementById('ticketScreen').classList.add('hidden');
                document.getElementById('arrivalBanner').classList.add('hidden');
                alert('‚úÖ Route data cleared!');
            }
        }
        
        function loadDemo() {
            const demo = `Route Name,Stop #,Contact Name,Contact Phone,Customer Name,Customer Phone,Street Address,GPS Latitude,GPS Longitude,Email,Service Type,Frequency,Contact Method
Route A,1,John Smith,239-555-1234,ABC Lawn Care,239-555-1000,123 Main Street Naples FL,26.1420,-81.7948,john@abc.com,Lawn and Ornamental,Monthly,Email
Route A,2,Jane Doe,239-555-5678,XYZ Pest Control,239-555-2000,456 Oak Avenue Fort Myers FL,26.6406,-81.8723,jane@xyz.com,General Household Pest,Quarterly,Phone
Route A,3,Bob Wilson,239-555-9012,Wilson Properties,239-555-3000,789 Pine Road Cape Coral FL,26.5629,-81.9495,bob@wilson.com,Termite,Annual,Text`;
            
            document.getElementById('csvInput').value = demo;
            alert('‚úÖ Demo loaded! Tap "Load Route" to continue.');
        }
        
        function loadRoute() {
            const csvData = document.getElementById('csvInput').value.trim();
            
            if (!csvData) {
                alert('Please paste CSV data first!');
                return;
            }
            
            try {
                const lines = csvData.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    alert('CSV appears empty');
                    return;
                }
                
                const headers = parseCSVLine(lines[0]);
                const indices = {
                    stopNum: findColumn(headers, ['Stop #', 'Stop']),
                    customerName: findColumn(headers, ['Customer Name', 'Name']),
                    address: findColumn(headers, ['Street Address', 'Address']),
                    lat: findColumn(headers, ['GPS Latitude', 'Latitude']),
                    lng: findColumn(headers, ['GPS Longitude', 'Longitude']),
                    phone: findColumn(headers, ['Customer Phone', 'Phone']),
                    serviceType: findColumn(headers, ['Service Type']),
                    frequency: findColumn(headers, ['Frequency'])
                };
                
                if (indices.lat === -1 || indices.lng === -1) {
                    alert('CSV must have GPS Latitude and Longitude');
                    return;
                }
                
                customers = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    const lat = parseFloat(values[indices.lat]);
                    const lng = parseFloat(values[indices.lng]);
                    
                    if (isNaN(lat) || isNaN(lng)) continue;
                    
                    customers.push({
                        stopNumber: indices.stopNum !== -1 ? values[indices.stopNum] : i,
                        customerName: indices.customerName !== -1 ? values[indices.customerName] : 'Customer ' + i,
                        address: indices.address !== -1 ? values[indices.address] : '',
                        lat: lat,
                        lng: lng,
                        phone: indices.phone !== -1 ? values[indices.phone] : '',
                        serviceType: indices.serviceType !== -1 ? values[indices.serviceType] : '',
                        frequency: indices.frequency !== -1 ? values[indices.frequency] : '',
                        completed: false
                    });
                }
                
                if (customers.length === 0) {
                    alert('No valid customers found');
                    return;
                }
                
                completedTickets = [];
                saveData(); // Save after loading route
                showRouteScreen();
                updateStats();
                displayCustomers();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }
        
        function findColumn(headers, names) {
            for (let name of names) {
                const idx = headers.findIndex(h => 
                    h.toLowerCase().replace(/[^a-z0-9]/g, '') === 
                    name.toLowerCase().replace(/[^a-z0-9]/g, '')
                );
                if (idx !== -1) return idx;
            }
            return -1;
        }
        
        function showRouteScreen() {
            document.getElementById('loadScreen').classList.add('hidden');
            document.getElementById('routeScreen').classList.remove('hidden');
            document.getElementById('ticketScreen').classList.add('hidden');
            document.getElementById('arrivalBanner').classList.add('hidden');
        }
        
        function showTicketScreen() {
            document.getElementById('loadScreen').classList.add('hidden');
            document.getElementById('routeScreen').classList.add('hidden');
            document.getElementById('ticketScreen').classList.remove('hidden');
            document.getElementById('arrivalBanner').classList.add('hidden');
        }
        
        function showArrivalScreen() {
            document.getElementById('loadScreen').classList.add('hidden');
            document.getElementById('routeScreen').classList.add('hidden');
            document.getElementById('ticketScreen').classList.add('hidden');
            document.getElementById('arrivalBanner').classList.remove('hidden');
        }
        
        function updateStats() {
            const completed = customers.filter(c => c.completed).length;
            document.getElementById('totalStops').textContent = customers.length;
            document.getElementById('completedStops').textContent = completed;
            document.getElementById('remainingStops').textContent = customers.length - completed;
        }
        
        function displayCustomers() {
            const list = document.getElementById('customerList');
            list.innerHTML = '';
            
            customers.forEach((customer, index) => {
                const card = document.createElement('div');
                card.className = 'customer-card' + (customer.completed ? ' completed' : '') + (index === navigatingToIndex ? ' active' : '');
                card.innerHTML = `
                    <div class="customer-number">${customer.stopNumber}</div>
                    ${customer.completed ? '<span class="completed-badge">‚úì DONE</span>' : ''}
                    ${index === navigatingToIndex ? '<span class="active-badge">üß≠ NAVIGATING</span>' : ''}
                    <div class="customer-name">${customer.customerName}</div>
                    <div class="customer-address">üìç ${customer.address}</div>
                    <div style="font-size:12px;color:#888;margin-top:5px;">
                        ${customer.serviceType || ''} ${customer.frequency ? '- ' + customer.frequency : ''}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-navigate" onclick="navigateTo(${index})">
                            üß≠ Navigate
                        </button>
                        <button class="btn btn-success" onclick="openTicket(${index})">
                            ${customer.completed ? 'üëÅÔ∏è View' : 'üìù Service'}
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        function navigateTo(index) {
            navigatingToIndex = index;
            const customer = customers[index];
            
            // Use EXACT GPS coordinates - most accurate!
            const url = `https://www.google.com/maps/dir/?api=1&destination=${customer.lat},${customer.lng}&travelmode=driving`;
            
            // Show arrival screen
            document.getElementById('arrivalCustomerInfo').innerHTML = `
                <div style="background: #f8f9ff; padding: 15px; border-radius: 10px;">
                    <div style="font-size: 18px; font-weight: 700; color: #333; margin-bottom: 8px;">
                        ${customer.customerName}
                    </div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        üìç ${customer.address}
                    </div>
                    <div style="font-size: 13px; color: #888;">
                        GPS: ${customer.lat}, ${customer.lng}
                    </div>
                </div>
            `;
            
            showArrivalScreen();
            displayCustomers();
            
            // Open Google Maps - app stays open!
            window.open(url, '_blank');
        }
        
        function arrivedAtCustomer() {
            if (navigatingToIndex !== -1) {
                openTicket(navigatingToIndex);
                navigatingToIndex = -1;
            }
        }
        
        function optimizeRoute() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        
                        const incomplete = customers.filter(c => !c.completed);
                        const optimized = [];
                        let remaining = [...incomplete];
                        let currentLat = userLat;
                        let currentLng = userLng;
                        
                        while (remaining.length > 0) {
                            let nearestIdx = 0;
                            let nearestDist = distance(currentLat, currentLng, remaining[0].lat, remaining[0].lng);
                            
                            for (let i = 1; i < remaining.length; i++) {
                                const dist = distance(currentLat, currentLng, remaining[i].lat, remaining[i].lng);
                                if (dist < nearestDist) {
                                    nearestDist = dist;
                                    nearestIdx = i;
                                }
                            }
                            
                            const nearest = remaining.splice(nearestIdx, 1)[0];
                            optimized.push(nearest);
                            currentLat = nearest.lat;
                            currentLng = nearest.lng;
                        }
                        
                        const completed = customers.filter(c => c.completed);
                        customers = [...optimized, ...completed];
                        customers.forEach((c, i) => c.stopNumber = i + 1);
                        
                        saveData(); // Save optimized route
                        displayCustomers();
                        alert('‚úÖ Route optimized from your current location!');
                    },
                    () => alert('‚ùå Could not get your location')
                );
            }
        }
        
        function distance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        function openTicket(index) {
            currentCustomerIndex = index;
            const customer = customers[index];
            
            document.getElementById('ticketHeader').innerHTML = `
                <div style="font-size:18px;font-weight:700;margin-bottom:5px;">${customer.customerName}</div>
                <div style="font-size:13px;">üìç ${customer.address}</div>
            `;
            
            // Set current date automatically
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('serviceDate').value = dateStr;
            
            // Start timer if not already started
            if (!arrivalTime) {
                startArrivalTimer();
            }
            
            // Clear form
            document.getElementById('problemTreated').value = '';
            document.getElementById('treatmentType').value = '';
            document.getElementById('areaTreated').value = '';
            document.getElementById('chemicalUsed').value = '';
            document.getElementById('rateUsed').value = '';
            document.getElementById('gallonsUsed').value = '';
            document.getElementById('equipmentUsed').value = '';
            document.getElementById('serviceNotes').value = '';
            currentPhoto = null;
            document.getElementById('photoPreview').classList.add('hidden');
            
            showTicketScreen();
        }
        
        function saveTicket() {
            const customer = customers[currentCustomerIndex];
            
            const ticket = {
                customer: customer.customerName,
                address: customer.address,
                date: document.getElementById('serviceDate').value,
                timeOnSite: getElapsedTime(),
                problemTreated: document.getElementById('problemTreated').value,
                treatmentType: document.getElementById('treatmentType').value,
                areaTreated: document.getElementById('areaTreated').value,
                chemicalUsed: document.getElementById('chemicalUsed').value,
                rateUsed: document.getElementById('rateUsed').value,
                gallonsUsed: document.getElementById('gallonsUsed').value,
                equipmentUsed: document.getElementById('equipmentUsed').value,
                serviceNotes: document.getElementById('serviceNotes').value,
                photo: currentPhoto
            };
            
            completedTickets.push(ticket);
            customers[currentCustomerIndex].completed = true;
            
            // Reset timer for next customer
            stopArrivalTimer();
            arrivalTime = null;
            
            saveData(); // Save progress
            updateStats();
            displayCustomers();
            showRouteScreen();
            
            const remaining = customers.filter(c => !c.completed).length;
            if (remaining > 0) {
                setTimeout(() => {
                    if (confirm(`‚úÖ Ticket saved!\n\n${remaining} stops remaining.\n\nNavigate to next customer?`)) {
                        const nextIndex = customers.findIndex(c => !c.completed);
                        if (nextIndex !== -1) {
                            navigateTo(nextIndex);
                        }
                    }
                }, 300);
            } else {
                alert('üéâ All stops completed!\n\nTap "Export Completed Tickets" to save for billing.');
            }
        }
        
        function backToRoute() {
            stopArrivalTimer();
            arrivalTime = null;
            navigatingToIndex = -1;
            showRouteScreen();
        }
        
        function openCamera() {
            document.getElementById('cameraInput').click();
        }
        
        function handlePhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentPhoto = e.target.result;
                    document.getElementById('photoImage').src = currentPhoto;
                    document.getElementById('photoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removePhoto() {
            currentPhoto = null;
            document.getElementById('photoPreview').classList.add('hidden');
        }
        
        function exportTickets() {
            if (completedTickets.length === 0) {
                alert('No completed tickets to export');
                return;
            }
            
            let csv = 'Customer,Address,Date,Time On Site,Problem,Treatment,Area,Chemical,Rate,Gallons,Equipment,Notes\n';
            
            completedTickets.forEach(ticket => {
                csv += `"${ticket.customer}","${ticket.address}","${ticket.date}","${ticket.timeOnSite || '0:00'}","${ticket.problemTreated}","${ticket.treatmentType}","${ticket.areaTreated}","${ticket.chemicalUsed}","${ticket.rateUsed}","${ticket.gallonsUsed}","${ticket.equipmentUsed}","${ticket.serviceNotes}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Tickets_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert(`‚úÖ ${completedTickets.length} tickets exported!\n\nEmail file to office for billing.`);
        }
        
        function newRoute() {
            clearSavedData();
        }
    </script>
</body>
</html>